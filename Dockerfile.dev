# =============================================================================
# Agent Manager - Development Dockerfile
# =============================================================================
#
# Development mode with:
#   - Volume-mounted source code
#   - npm-linked busibox-app for live editing
#   - Turbopack hot-reload
#
# Usage (via docker-compose.dev.yml):
#   docker compose -f docker-compose.local.yml -f docker-compose.dev.yml up
#
# =============================================================================

FROM node:20-alpine

# Set working directory
WORKDIR /app

# Install dependencies for node-gyp and development tools
RUN apk add --no-cache python3 make g++ curl bash

# Copy package files
COPY package.json package-lock.json ./

# Set up npm authentication for private GitHub packages
# GITHUB_AUTH_TOKEN must be passed as a build arg (from .env.local or environment)
ARG GITHUB_AUTH_TOKEN
RUN if [ -n "$GITHUB_AUTH_TOKEN" ]; then \
        echo "Setting up npm authentication for @jazzmind packages..." && \
        echo "//npm.pkg.github.com/:_authToken=${GITHUB_AUTH_TOKEN}" > .npmrc && \
        echo "@jazzmind:registry=https://npm.pkg.github.com" >> .npmrc; \
    else \
        echo "WARNING: GITHUB_AUTH_TOKEN not set - npm install may fail for @jazzmind packages"; \
    fi

# Install dependencies
# Note: busibox-app will be npm-linked at runtime from the volume mount
# Retry npm ci up to 3 times in case of network issues
RUN npm ci || (sleep 5 && npm ci) || (sleep 10 && npm ci)

# Copy entrypoint script
COPY scripts/docker/dev-entrypoint.sh /usr/local/bin/dev-entrypoint.sh
RUN chmod +x /usr/local/bin/dev-entrypoint.sh

# Copy the rest of the application
# Note: This will be overwritten by volume mount in development
COPY . .

# Expose port
EXPOSE 3001

# Environment
ENV NODE_ENV=development
ENV PORT=3001
ENV HOSTNAME=0.0.0.0

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=5 \
    CMD curl -f http://localhost:3001/ || exit 1

# Use entrypoint script to handle npm link and start dev server
ENTRYPOINT ["/usr/local/bin/dev-entrypoint.sh"]
CMD ["npm", "run", "dev", "--", "-p", "3001"]
