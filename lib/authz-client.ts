/**
 * AuthZ Client for Agent Manager
 *
 * Zero Trust Authentication Architecture:
 * - Uses busibox-session cookie (RS256 JWT from authz) as subject_token
 * - This is the actual authz session JWT, shared across all busibox apps
 * - NO client credentials required for user operations
 * - The session JWT cryptographically proves user identity
 * - Can be exchanged for downstream service tokens via authz token exchange
 *
 * This module uses the shared Zero Trust functions from busibox-app.
 */

import {
  exchangeTokenZeroTrust,
  getAuthHeaderZeroTrust,
  type AuthzAudience as SharedAuthzAudience,
  type ZeroTrustExchangeResponse,
} from '@jazzmind/busibox-app';

// Re-export types
export type AuthzAudience = SharedAuthzAudience;

export interface AuthzTokenResponse {
  accessToken: string;
  tokenType: 'bearer';
  expiresIn: number;
  scope: string;
}

function getAuthzBaseUrl(): string {
  return process.env.AUTHZ_BASE_URL || 'http://authz-api:8010';
}

/**
 * Exchange session JWT for an authz access token (Zero Trust)
 *
 * Uses the busibox-session cookie value (RS256 JWT from authz) as subject_token.
 * No client credentials required - the session JWT cryptographically proves user identity.
 *
 * @param sessionJwt - The session JWT from busibox-session cookie
 * @param audience - The target service (e.g., 'agent-api')
 * @param scopes - Optional scopes to request
 * @returns Authz token response
 */
export async function exchangeForAuthzToken(
  sessionJwt: string,
  audience: AuthzAudience,
  scopes?: string[]
): Promise<AuthzTokenResponse> {
  // Use the session JWT for Zero Trust token exchange
  const result = await exchangeTokenZeroTrust(
    {
      sessionJwt,
      audience,
      scopes,
      purpose: 'agent-manager',
    },
    {
      authzBaseUrl: getAuthzBaseUrl(),
      verbose: process.env.VERBOSE_AUTHZ_LOGGING === 'true',
    }
  );

  return {
    accessToken: result.accessToken,
    tokenType: result.tokenType,
    expiresIn: result.expiresIn,
    scope: result.scope,
  };
}

/**
 * Get an authz token for agent-api calls (Zero Trust)
 *
 * @param sessionJwt - The session JWT from busibox-session cookie
 * @returns Bearer token string for Authorization header
 */
export async function getAgentApiToken(sessionJwt: string): Promise<string> {
  const result = await exchangeForAuthzToken(sessionJwt, 'agent-api', ['agents:read', 'agents:write']);
  return result.accessToken;
}

/**
 * Get an authz token for test user (local development only)
 *
 * In Zero Trust mode, this still requires a valid session JWT.
 * For local testing, use the TEST_SESSION_JWT environment variable.
 *
 * @param userId - Test user ID (not used in Zero Trust mode - included for API compatibility)
 * @returns Bearer token string for Authorization header
 */
export async function getAgentApiTokenForTestUser(userId: string): Promise<string> {
  const testSessionJwt = process.env.TEST_SESSION_JWT;

  if (!testSessionJwt) {
    throw new Error(
      'TEST_SESSION_JWT not configured. In Zero Trust mode, a valid session JWT is required even for test users. ' +
        'Set TEST_SESSION_JWT to a valid session JWT from the authz service.'
    );
  }

  const result = await exchangeForAuthzToken(testSessionJwt, 'agent-api', [
    'agents:read',
    'agents:write',
  ]);
  return result.accessToken;
}

/**
 * Get authorization header using Zero Trust exchange
 * 
 * @param sessionJwt - The session JWT from busibox-session cookie
 */
export async function getAuthorizationHeader(
  sessionJwt: string,
  audience: AuthzAudience,
  scopes?: string[]
): Promise<string> {
  return getAuthHeaderZeroTrust(
    {
      sessionJwt,
      audience,
      scopes,
      purpose: 'agent-manager',
    },
    {
      authzBaseUrl: getAuthzBaseUrl(),
      verbose: process.env.VERBOSE_AUTHZ_LOGGING === 'true',
    }
  );
}
